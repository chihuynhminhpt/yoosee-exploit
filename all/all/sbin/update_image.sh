#! /mnt/bin/sh

VAR1="uImage"
VAR2="root.sqsh4"
VAR3="usr.sqsh4"
VAR4="usr.jffs2"

ZMD5="uImage.md5"
SMD5="usr.sqsh4.md5"
JMD5="usr.jffs2.md5"
RMD5="root.sqsh4.md5"

DIR1="/tmp"


update_ispconfig()
{
	rm -rf /etc/jffs2/isp*.conf
}

update_kernel()
{
	echo "check ${VAR1}............................."

	if [ -e ${DIR1}/${VAR1} ] 
	then
		if [ -e ${DIR1}/${ZMD5} ];then
        	result=`md5sum -c ${DIR1}/${ZMD5} | grep OK`
			if [ -z "$result" ];then
	    		echo "MD5 check zImage failed, can't updata"
	    		return
			else
	    		echo "MD5 check zImage success"
		    fi  
		fi
		echo "update ${VAR1} under ${DIR1}...."
   		updater local KERNEL=${DIR1}/${VAR1}
   fi  
}

update_squash()
{
	echo "check ${VAR3}.........................."
	if [ -e ${DIR1}/${VAR3} ]
	then
		if [ -e ${DIR1}/${SMD5} ];then
	        result=`md5sum -c ${DIR1}/${SMD5} | grep OK`
	        if [ -z "$result" ];then
		        echo "MD5 check usr.sqsh4 failed, can't updata"
		        return
		    else
		        echo "MD5 check usr.sqsh4 success"
		    fi
		fi
        echo "update ${VAR3} under ${DIR1}...."
 		updater local C=${DIR1}/${VAR3}
	fi
}


update_jffs2()
{
	echo "check ${VAR4}........................"
	if [ -e ${DIR1}/${VAR4} ]
	then
		if [ -e ${DIR1}/${JMD5} ];then
	        result=`md5sum -c ${DIR1}/${JMD5} | grep OK`
	        if [ -z "$result" ];then
		        echo "MD5 check usr.jffs2 failed, can't updata"
		        return
		    else
		        echo "MD5 check usr.jffs2 success"
		    fi
		fi
		echo "update ${VAR4} under ${DIR1}...."
		updater local B=${DIR1}/${VAR4}
	fi
}

update_rootfs_squash()
{
	echo "check ${VAR2}.........................."
    if [ -e ${DIR1}/${VAR2} ]
    then
	    if [ -e ${DIR1}/${RMD5} ];then
	        result=`md5sum -c ${DIR1}/${RMD5} | grep OK`
	        if [ -z "$result" ];then
		        echo "MD5 check root.sqsh4 failed, can't updata"
		        return
		    else
		        echo "MD5 check root.sqsh4 success"
		    fi
		fi
        echo "update ${VAR2} under ${DIR1}...."
		updater local A=${DIR1}/${VAR2}
	fi
}

echo "############ updater_image.sh  begin#############"

update_ispconfig
update_kernel
update_jffs2
update_squash
update_rootfs_squash

echo "############ update finished, reboot now #############"

sleep 3
reboot -f



